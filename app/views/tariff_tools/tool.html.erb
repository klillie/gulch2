<h1>Bill Comparison (Demo)</h1>

<p> <!-- gets all the data needed to display the bill -->
	<% @zip = session[:zip_code] %>
	<% @demand = session[:demand_in_kW] %>
	<% @usage = session[:usage_in_kWh] %>
	<% @date = session[:bill_date] %>
	<% @phases = session[:phases] %>

	<% @utility = TariffUtility.utility(@zip) %> 
	<% @territory = TariffTerritory.territory(@zip) %>
	<% @season = TariffSeason.season(@date, @zip) %> 
	<% @tou = TariffTou.tou(@date, @zip) %>
	<% @meter_read = TariffMeterRead.meter_read(@date, @zip) %>
	<% @billing_class = TariffBillingClass.billing_class(@zip, @demand, @usage, @phases) %>
	<% @tariffs = TariffTariff.tariffs(@billing_class) %>
	<% @line_items = TariffLineItems.line_items(@tariffs, @date, @season) %>
	<% @bill_groups = TariffBillGroup.bill_groups(@billing_class) %>	
	
	<!-- shows the utility and billing period -->
	<%= @date %>
	<br> <!-- enters a blank line, ie: line break -->
	<%= @utility.name %>
	<br> <!-- enters a blank line, ie: line break -->
	<strong> Billing Period: <%= @meter_read["start_date"] %> to <%= @meter_read["end_date"] %> </strong>
	<br> <!-- enters a blank line, ie: line break -->

</p>

<p> <!-- this area shows the header information for the bill -->
	kWh used = <%= @usage %>
	<br> <!-- enters a blank line, ie: line break -->
	Billed Load in kW = <%= @demand %>
	<br> <!-- enters a blank line, ie: line break -->
	<br> <!-- enters a blank line, ie: line break -->
	Rate: <%= @billing_class[0].name %>
	<br> <!-- enters a blank line, ie: line break -->

	<!-- sorts the line items by bill group -->
	<% @line_items.sort_by{ |i| i.bill_group_order} %>
	<% @bill_groups.sort_by{ |i| i.order} %>

</p>

<% @bill_total = 0 %>
<% @bill_groups.each do |j| %>
	<!-- shows the name of the section of the bill -->
	<strong><%= j.name %></strong>
	<br> <!-- enters a blank line, ie: line break -->
	
	<table> <!-- to test my understanding of tables -->
		<% @bill_group_total = 0 %>
		<% @line_items.each do |i| %>
			<% if j.id == i.bill_group_id %>
				<tr>
					<td> <%= i.name %> </td> <!-- name -->
					<% case i.line_item_type %>
					<% when '$/month' %>
						<td> </td>	<!-- value -->
						<td> </td> 	<!-- value label -->
						<td> </td>	<!-- math symbol -->
						<td> </td> 	<!-- rate -->
						<td> 
							<% @bill_group_total += i.rate %>
							<%= number_to_currency(i.rate) %> <!-- total -->
						</td> 

					<% when '$/kW' %>
						<td> <%= @demand %> </td>	<!-- value -->
						<td> kW </td> 	<!-- value label -->
						<td> x </td>	<!-- math symbol -->
						<td> <%= number_to_currency(i.rate, precision: 3) %> </td> 	<!-- rate -->
						<td> 
							<% @bill_group_total += (i.rate * @demand.to_f) %>
							<%= number_to_currency(i.rate * @demand.to_f) %> <!-- total -->
						</td> 
					<% when '$/kWh' %>
						<td> <%= @usage %> </td>	<!-- value -->
						<td> kWh </td> 	<!-- value label -->
						<td> x </td>	<!-- math symbol -->
						<td> <%= number_to_currency(i.rate, precision: 6) %> </td> 	<!-- rate -->
						<td> 
							<% @bill_group_total += (i.rate * @usage.to_f) %>
							<%= number_to_currency(i.rate * @usage.to_f) %> <!-- total -->
						</td> 
					<% else %>
						<td> <%= i.line_item_type %> </td>

					<% end %>
				</tr>
			<% end %>
		<% end %>
	</table>
	<!-- determines the total for that section of the bill -->
	&nbsp &nbsp &nbsp &nbsp &nbsp Total for <%= j.name %> = <%= number_to_currency(@bill_group_total) %>
	<% @bill_total += @bill_group_total %>
	<br> <!-- enters a blank line, ie: line break -->
<% end %>
<p>
	Total Bill = <%= number_to_currency(@bill_total) %>
</p>
